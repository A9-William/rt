#!/usr/bin/env perl -w

use strict;
use File::Find;
use File::Copy;
use Regexp::Common;
use Carp;

use vars qw ($DEBUG);

$DEBUG = 1;

@ARGV = <lib/RT/I18N/*.po> unless @ARGV;

foreach my $lang (@ARGV) {
    $lang =~ s|.*/||; $lang =~ s|\.po$||;
    # eval { update($lang) } or warn $@;
    update($lang);
}

sub update {
    my $lang = shift;

    print "Updating $lang...\n";
    
    my (%Lexicon, %file);
    my $out = '';

    
    open LEXICON, "lib/RT/I18N/$lang.po" or warn $@;
    while (<LEXICON>) {
	if (1 .. /^$/) { $out .= $_; next }

	my $msgid = <LEXICON>;
	my $msgstr = <LEXICON>;
	<LEXICON>;
	chomp $msgid;
	chomp $msgstr;
	$msgid =~ s/^msgid "(.*)"$/$1/ or die $msgid;
	$msgstr =~ s/^msgstr "(.*)"$/$1/ or die $msgstr;
	$Lexicon{$msgid}=$msgstr;
    }

    local $/;
    print "Done reading lexicon \n";

    File::Find::find({wanted => \&extract_strings_from_code, follow => 1}, '.');

    sub extract_strings_from_code {
	my $file = $_;
	return if ($File::Find::dir =~ 'lib/blib|lib/t/autogen');
	return if ($_ =~ /.bak$|~|,D|,B$/);
	return if ($_ =~ /^#/);
	print "Looking at $File::Find::name\n";
	my $r = $File::Find::name; 
	open _, $file or die $!; $_ = <_>; $r =~ s'^./'';
	while (s!<&\|/l.*?&>(.*?)</&>!!s) {
	    my $u = $1; 
            $u =~ s/\\'/\'/g; 
            $file{$u}{$r}++;
	}

	while (s!loc\(($RE{delimited}{-delim=>"'"}{-esc}{-keep})!!s) {
	    my $u = substr($1, 1, -1); 
            $u =~ s/\\'/\'/g; 
            $file{$u}{$r}++;
	}

	while (s!loc\(($RE{delimited}{-delim=>'"'}{-esc}{-keep})!!s) {
	    my $u = substr($1, 1, -1); 
            $u =~ s/\\'/\'/g; 
            $file{$u}{$r}++;
	}

	while (s!($RE{delimited}{-delim=>"'"}{-esc}{-keep})[\}\)\],]*\s*\#\s*loc\s*\n!!s) {
	    my $u = substr($1, 1, -1); 
            $u =~ s/\\'/\'/g; 
            $file{$u}{$r}++;
	}

	while (s!($RE{delimited}{-delim=>'"'}{-esc}{-keep})[\}\)\],]*\s*\#\s*loc\s*\n!!s) {
	    my $u = substr($1, 1, -1); 
            $u =~ s/\\'/\'/g; 
            $file{$u}{$r}++;
	}
    }

    foreach (sort keys %file) {
	my $k = $file{$_};

	s/\\/\\\\/g;
	s/\"/\\"/g;
	s/\[_(\d+)\]/%$1/g;
	s/~([\[\]])/$1/g;

	$file{$_} = $k;
	$Lexicon{$_} ||= '';
    }

    my $is_english = ($lang =~/^en(?:[^A-Za-z]|$)/);

    delete $file{''};
    foreach (sort keys %Lexicon) {
	my $f = join(' ', sort keys %{$file{$_}});
	$f = " $f" if length $f;
	my $nospace = $_;
	$nospace =~ s/ +$//;

	if (!$Lexicon{$_} and $Lexicon{$nospace}) {
	    $Lexicon{$_} = $Lexicon{$nospace} . (' ' x (length($_) - length($nospace)));
	}

	next if !length($Lexicon{$_}) and $is_english;

	$out .= "#:$f\nmsgid \"$_\"\nmsgstr \"$Lexicon{$_}\"\n\n";
    }

    open _, ">lib/RT/I18N/$lang.po" or die $!;
    print _ $out;
    close _;

    return 1;
}

# pull strings out of the code.

