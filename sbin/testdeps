#!/usr/bin/perl -w
# BEGIN LICENSE BLOCK
# 
# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
# 
# (Except where explictly superceded by other copyright notices)
# 
# This work is made available to you under the terms of Version 2 of
# the GNU General Public License. A copy of that license should have
# been provided with this software, but in any event can be snarfed
# from www.gnu.org
# 
# This work is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
# 
# 
# Unless otherwise specified, all modifications, corrections or
# extensions to this work which alter its source code become the
# property of Best Practical Solutions, LLC when submitted for
# inclusion in the work.
# 
# 
# END LICENSE BLOCK

#
# This is just a basic script that checks to make sure that all
# the modules needed by RT before you can install it.
#

use strict;

use vars qw($mode $dbd @modules);

$mode = shift || print_help();
$dbd = shift || print_help();

my @core_modules = qw(
Digest::MD5
Bundle::CPAN
CPAN 1.60
DBI 1.18
Test::Inline
Class::ReturnValue 0.21
DBIx::SearchBuilder 0.70
Text::Template
File::Spec 0.8
HTML::Entities 
Net::Domain
Log::Dispatch 1.6
Locale::Maketext
Locale::Maketext::Lexicon 0.091
Locale::Maketext::Fuzzy
MIME::Entity 5.108
Mail::Mailer 1.20
Net::SMTP
Text::Wrapper 
Date::Parse
Date::Format 
File::Temp 
);
my @mason_modules = qw(
Params::Validate 0.02
Cache::Cache
Exception::Class
HTML::Mason 1.10
MLDBM
Errno
FreezeThaw
Digest::MD5
CGI::Cookie 1.20
Storable
Apache::Session 1.53);

my @cli_modules = qw(
Getopt::Long 2.24
);

my @dev_modules = qw(
Regexp::Common
Time::HiRes 
Test::Inline 
);

my @fcgi_modules = qw(
FCGI
CGI::Fast 
);

my @modperl_modules = qw( 
Apache::Request 
);

my @db_modules;

if ($dbd =~ /mysql/i) {
        @db_modules = qw(DBD::mysql 2.0416
        );
}
elsif ($dbd =~ /oracle/i) {
        @db_modules = qw(DBD::Oracle
        );
}
elsif ($dbd =~ /pg/i) {
        @db_modules = qw(DBD::Pg
        );
}


@modules =  (@core_modules, @mason_modules, @cli_modules, @dev_modules, @db_modules, @fcgi_modules, @modperl_modules);

use CPAN;

while (my $module= shift @modules) {
	my $version = "";
        next unless ($module);
	$version = " ". shift (@modules) . " " if (@modules && $modules[0] =~ /^([\d\.]*)$/);
	print "Checking for $module$version";
	eval "use $module$version" ;
	if ($@) {
	&resolve_dependency($module, $version) 
	}
	else {
	print "...found\n";
	}
}

sub print_help {
print <<EOF;

$0 FLAG DBTYPE


$0 is a tool for RT that will tell you if you've got all
the modules RT depends on properly installed.

Flags: (only one flag is valid for a given run)

-quiet will check to see if we've got everything we need
	and will exit with a return code of (1) if we don't.

-warn will tell you what isn't properly installed

-fix will use CPAN to magically make everything better

DBTYPE is one of:
	oracle, pg, mysql

EOF

exit(0);
}

sub resolve_dependency {
	my $module = shift;
	my $version = shift;
        print "....$module$version not installed.";
    if ($mode =~ /-f/) {
	$module = "DBD::mysql::Install" if ($module =~ /DBD::mysql/);
	
        print "Installing with CPAN...";
        CPAN::install($module);
     }
     print "\n";
	exit(1) if ($mode =~ /-q/);
}	
	
