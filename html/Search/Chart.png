<%args>
$Query => "id > 0"
$PrimaryGroupBy => 'Queue'
$SecondaryGroupBy => undef
</%args>
<%init>
my @keys;
my @values;
use GD::Graph::bars;
use RT::Report::Tickets;

my $chart = GD::Graph::bars->new( 600 => 400 );
my $tix   = RT::Report::Tickets->new( $session{'CurrentUser'} );

my @groupby = (
    { FIELD => $PrimaryGroupBy },

    #{ FIELD => $SecondaryGroupBy}
);
$tix->GroupByCols(@groupby);
$tix->Column( FUNCTION => 'COUNT', FIELD => 'id' );
$tix->Column( FIELD => $PrimaryGroupBy );

#$tix->Column( FIELD => $SecondaryGroupBy);
$tix->FromSQL($Query);
$tix->_DoSearch();
warn YAML::Dump($tix);
while ( my $entry = $tix->Next ) {
    my $class;
    if ( $PrimaryGroupBy eq 'Queue' ) {
         $class = "RT::Queue";
        }
        elsif ( $PrimaryGroupBy eq 'Owner' ) {
             $class = "RT::User";
        }
        if ($class) {
            warn "Trying to load class $class";
            warn  $entry->__Value($PrimaryGroupBy);
            my $q = $class->new( $session{'CurrentUser'} );
            $q->Load( $entry->__Value($PrimaryGroupBy) );
            push @keys, $q->Name();
        }
        else {
            push @keys, $entry->__Value($PrimaryGroupBy);
        }
        push @values, $entry->id;
    }
    use YAML;
    warn YAML::Dump \@keys;

    $chart->set(
        x_label => $PrimaryGroupBy,
        y_label => 'Tickets',
        title   => "$Query\n split by $PrimaryGroupBy",
      )
      or die $chart->error;

    my $plot = $chart->plot( [ [@keys], [@values] ] ) or die $chart->error;
    $r->content_type('image/png');
    $m->out( $plot->png );
    $m->abort();
</%init>
