<& /Elements/Header, title => "Search for articles" &>
<& /RTFM/Elements/Tabs&>

% use Data::Dumper;
<pre>
<%Dumper($articles)%>
</pre>
<ul>
% while (my $article = $articles->Next) {

<li><a href="Display.html?id=<%$article->Id%>">#<%$article->id%>: <%$article->Name%></a>
<br><font size="-1"><%$article->Summary%></font>
</li>
% }
</ul>

<h2>Search</h2>

<form target="Search.html" method="GET">
<br>Class is <& ../Elements/SelectClass, Name => 'Class', Default =>
$ARGS{'Class'} &>
<br>Name
<& /Elements/SelectMatch, Name => 'NameOp' , Default => $ARGS{'NameOp'} &>
<input name="Name" value="<%$ARGS{'Name'}%>">

<br>Summary
<& /Elements/SelectMatch, Name => 'SummaryOp',  Default => $ARGS{'SummaryOp'}&>
<input name="Summary" value="<%$ARGS{'Summary'}%>">

<br>Created between
<& /Elements/SelectDate, Name=>"CreatedBefore", Default => $ARGS{'CreatedBefore'}&>
and <& /Elements/SelectDate, Name=>"CreatedAfter", Default =>  $ARGS{'CreatedAfter'}&>

<br>Updated between
<& /Elements/SelectDate, Name=>"UpdatedBefore", Default => $ARGS{'UpdatedBefore'}&>
and <& /Elements/SelectDate, Name=>"UpdatedAfter", Default =>  $ARGS{'UpdatedAfter'}&>


<table>
%# for each custom field 
% while (my $field = $cfs->Next ) {

<tr>
<td><%$field->Name%> matches</td><td valign=top>
% my $arg = $field->Id."-Matches-Values";
<& Elements/SearchByCustomField, 
    Field => $field, 
    Name => $field->Id."-Matches", 
    Values => $ARGS{$arg} &>
    </td>
    <td>and doesn't match</td>
    <td valign="top">
% $arg = $field->Id."-NoMatches-Values";
<& Elements/SearchByCustomField, 
    Field => $field, 
    Name => $field->Id."-NoMatches", 
    Values => $ARGS{$arg}
    &>
    </td>
    </tr>

% }
</table>

<& /Elements/Submit, Label => loc('Show Results'), AlternateLabel => loc('Refine'), Name => 'Action'&>


</form>
<%init>
my $cfs = RT::FM::CustomFieldCollection->new($session{'CurrentUser'});
if ($ARGS{'Class'}) { 
    $cfs->LimitToClass($ARGS{'Class'});
}
my $articles = RT::FM::ArticleCollection->new($session{'CurrentUser'});
# Don't want to search for a null class when there is no class specced
foreach my $arg qw(Class Name Summary) {
    next unless (defined $ARGS{$arg} && $ARGS{$arg} ne ''); #ignore undef values
    $articles->Limit(FIELD => $arg,
                    OPERATOR => $ARGS{$arg."Op"} || '=',
                    VALUE => $ARGS{$arg});
}

foreach my $arg ( keys %ARGS ) {
    if ( $arg =~ /^(\d+)-Matches-Values$/ ) {
	    my @values =ref( $ARGS{$arg} ) ? @{ $ARGS{$arg} } : ( $ARGS{$arg} ); 
	    $articles->LimitToCustomFieldValue( FIELD=> $1,
                                            OPERATOR => 'LIKE',
                                            VALUE    => \@values );

    }
    if ( $arg =~ /^(\d+)-NoMatches-Values$/ ) {
	    my @values =ref( $ARGS{$arg} ) ? @{ $ARGS{$arg} } : ( $ARGS{$arg} ); 
        $articles->LimitToCustomFieldValue( FIELD    => $1,
                                            OPERATOR => 'NOT LIKE',
                                            VALUE    => \@values );

    }
}


</%init>
<%ARGS>
$CreatedBefore => ''
$CreatedAfter => ''
$UpdatedBefore => ''
$UpdatedAfter => ''


</%ARGS>
