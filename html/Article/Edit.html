%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2002 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK


<& /RTFM/Elements/Header, Title => loc('Modify article #[_1]', $ArticleObj->Id) &>
<& /RTFM/Article/Elements/Tabs, Article => $ArticleObj, current_tab => "Article/Edit.html?id=".$ArticleObj->Id , id => $id &>

<& /Elements/ListActions, actions => \@results &>

<FORM METHOD=POST ACTION="Edit.html">
<INPUT TYPE=HIDDEN NAME=id VALUE="<%$ArticleObj->Id%>">



<& Elements/EditBasics, ArticleObj => $ArticleObj &>
<& Elements/EditCustomFields, ArticleObj => $ArticleObj &>

<& /Elements/Submit, Label => loc('Save Changes'), Caption => loc("If you've updated anything above, be sure to"), color => "#993333" &>
</form>
<%INIT>

my @results;

my $Entries    = {};
my $ArticleObj = RT::FM::Article->new( $session{'CurrentUser'} );
$ArticleObj->Load($id);
unless ( $ArticleObj->id ) {
    Abort( loc("Unable to load article") );
}

my @attribs= qw(Name Summary Class);

  @results = UpdateRecordObject( AttributesRef => \@attribs, 
                                    Object => $ArticleObj, 
                                    ARGSRef => \%ARGS);




    my $CustomFields = $ArticleObj->ClassObj->CustomFields();

    # Build up a list of articles that we want to work with
    my %articles_to_mod;
    my %custom_fields_to_mod;
    foreach my $arg ( keys %ARGS ) {
        if ( $arg =~ /^Article-(\d+)-CustomField-(\d+)-/ ) {

            # For each of those articles, find out what custom fields we want to work with.
            $custom_fields_to_mod{$1}{$2} = 1;
        }
    }

    # For each of those Articles
    foreach my $article ( keys %custom_fields_to_mod ) {
        my $Article = RT::FM::Article->new( $session{'CurrentUser'} );
        $Article->Load($article);

        # For each custom field
        foreach my $cf ( keys %{ $custom_fields_to_mod{$article} } ) {

            foreach my $arg ( keys %ARGS ) {
                next unless ( $arg =~ /^Article-$article-CustomField-$cf-/ );
                my @values = ( ref( $ARGS{$arg} ) eq 'ARRAY' ) ? @{ $ARGS{$arg} } : ( $ARGS{$arg} );
                if ( ( $arg =~ /-AddValue$/ ) || ( $arg =~ /-Value$/ ) ) {
                    foreach my $value (@values) {
                        next unless ($value);
                        my ( $val, $msg ) = $Article->AddCustomFieldValue(
                        Field => $cf, Content => $value);
                        push ( @results, $msg );
                    }
                }
                elsif ( $arg =~ /-DeleteValues$/ ) {
                    foreach my $value (@values) {
                        next unless ($value);
                        my ( $val, $msg ) = $Article->DeleteCustomFieldValue(
                        Field => $cf, Content => $value);
                        push ( @results, $msg );
                    }
                }
                elsif ( $arg =~ /-Values$/ ) {
                    my $cf_values = $Article->CustomFieldValues($cf);

                    my %values_hash;
                    foreach my $value (@values) {
                        next unless ($value);

                        # build up a hash of values that the new set has
                        $values_hash{$value} = 1;
                        unless ( $cf_values->HasEntryWithContent($value) ) {
                            my ( $val, $msg ) = $Article->AddCustomFieldValue( Field => $cf, Content => $value);
                        push (@results,"finished the add");
                        }

                    }
                    while ( my $cf_value = $cf_values->Next ) {
                        unless ( $values_hash{ $cf_value->Content } == 1 ) {
                            my ( $val, $msg ) = $Article->DeleteCustomFieldValue( Field => $cf, Content => $cf_value->Content);
                            push ( @results, $msg );

                        }

                    }
                }
                else {
                    push ( @results, "User asked for an unknown update type for custom field " . $cf->Name . " for Article " . $Article->id );
                }
            }
        }

}

# TODO: display the results, even if we can't display the Article

unless ($ArticleObj->CurrentUserHasRight('ShowArticle')) {
    Abort("No permission to view Article");
} 

</%INIT>


<%ARGS>
$id => undef
</%ARGS>
