<div id="form-box-<% lc $Name %>">
% if ( $Description ) {
<% $Description %>:\
% }
<& SELF:InputOnly, %ARGS &>
</div>
<%ARGS>
$Name
$Description      => undef,
</%ARGS>

<%METHOD InputOnly>
<%ARGS>
$Name
$Description      => undef,

@Values           => (),
$ValuesCallback   => undef,
%ValuesLabel      => (),
@CurrentValue     => (),

$Empty            => 1,
@EmptyValue       => (),
$EmptyLabel       => loc('Use system default ([_1])', join ', ', @EmptyValue),

$Alternative      => 0,
$AlternativeLabel => loc('other...'),

$Multiple         => 0,
</%ARGS>
<select name="<% $Name %>">

% if ( $Empty ) {
% my $selected = '';
% $selected = 'selected="selected"' unless @CurrentValue;
<option value="__empty_value__" <% $selected |n %>><% $EmptyLabel %></option>
% }

% foreach my $v( @Values ) {
% my $selected = '';
% $selected = 'selected="selected"' if delete $CurrentValue{ $v };
<option value="<% $v %>" <% $selected |n %>><% $ValuesLabel{ $v } || $v %></option>
% }

% if ( $Alternative ) {
%     my $selected = '';
%     $selected = 'selected="selected"' if keys %CurrentValue;
<option value="__alternative_value__" <% $selected |n %>><% $AlternativeLabel %></option>
% }

</select>
% if ( $Alternative ) {
<input type="text" class="alternative" name="Alternative-<% $Name %>" value="<% join ', ', @CurrentValue %>" />
% }
</div>
<%INIT>
my %CurrentValue = map {$_ => 1} grep defined, @CurrentValue;
if ( $ValuesCallback ) {
    my $values = $ValuesCallback->(
        CurrentUser => $session{'CurrentUser'},
        Name        => $Name,
    );
    if ( ref $values eq 'ARRAY' ) {
        @Values = @$values;
    } else {
        %ValuesLabel = %$values;
        @Values = keys %ValuesLabel;
    }
}
</%INIT>
</%METHOD>

<%METHOD Process>
<%ARGS>
$Name

$Arguments        => {},

@Values           => (),
%ValuesLabel      => (),
@CurrentValue     => (),

$Empty            => 1,
$Alternative      => 0,
$Multiple         => 0,
</%ARGS>
<%INIT>
my $value = $Arguments->{ $Name };
if( !defined $value || $value eq '__empty_value__' ) {
    return undef if $Empty;
    return [ @CurrentValue ] if $Multiple;
    return $CurrentValue[0];
}
$value = [$value] unless ref $value;

if ( $Alternative ) {
    my $alt = $Arguments->{ "Alternative-". $Name };
    if( $Multiple ) {
        push @$value, split /\s*,\s*/, $alt;
    } else {
        push @$value, $alt;
    }
}

splice @$value, 1 unless $Multiple;

# XXX: check values

return $value->[0] unless $Multiple;
return $value;
</%INIT>
</%METHOD>
