%# BEGIN LICENSE BLOCK
%# 
%# Copyright (c) 1996-2003 Jesse Vincent <jesse@bestpractical.com>
%# 
%# (Except where explictly superceded by other copyright notices)
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# Unless otherwise specified, all modifications, corrections or
%# extensions to this work which alter its source code become the
%# property of Best Practical Solutions, LLC when submitted for
%# inclusion in the work.
%# 
%# 
%# END LICENSE BLOCK
<%perl>
     my ($ticket, $trans,$attach, $filename);
     my $arg = $m->dhandler_arg;                # get rest of path
     if ($arg =~ '^(\d+)/(\d+)') {
        $trans = $1;
        $attach = $2;
     }
    else {
        Abort("Corrupted attachment URL.");
        }
     my $AttachmentObj = new RT::Attachment($session{'CurrentUser'});
     $AttachmentObj->Load($attach) || Abort("Attachment '$attach' could not be loaded");


     unless ($AttachmentObj->id) {
        Abort("Bad attachment id. Couldn't find attachment '$attach'\n");
    }
     unless ($AttachmentObj->TransactionId() == $trans ) {
        Abort("Bad transaction number for attachment. $trans should be".$AttachmentObj->TransactionId() ."\n");

     }

     my $content_type =  $AttachmentObj->ContentType || 'text/plain';
        
     unless ($RT::TrustHTMLAttachments) {
         $content_type = 'text/plain' if ($content_type =~ /^text\/html/i);
     }

     unless ($RT::TrustMIMEAttachments) {
         $content_type = 'application/octet-stream' unless ($content_type eq 'text/plain');
     }

     $r->content_type( $content_type);
     $m->clear_buffer();
         # sometimes binary attachments is converted to utf-8.  this
         # seems to fix the problem.
         #
         # This bug is VERY DIFFICULT to reproduce.  You have to
         # reload many many times to get a chance to see it.  That's
         # why I'm not sure if this will fix it for good.

     if ($RT::TextAttachmentsAsUTF8) {
         my $Content = $AttachmentObj->Content;
         if ($AttachmentObj->ContentType =~ /^text\//i) {
                 Encode::_utf8_on($Content);
         }
         $m->out($Content);
     }
     else {
         $m->out($AttachmentObj->Content);
     }
     $m->abort; 
</%perl>

