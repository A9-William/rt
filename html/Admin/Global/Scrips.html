<& /Admin/Elements/Header, Title => loc('Edit scrips') &>
<& /Admin/Elements/SystemTabs &>

<& /Elements/ListActions, actions => \@actions &>

<& /Elements/TitleBoxStart, title => loc("Modify global scrips") &>
  
  <FORM METHOD=POST ACTION="Scrips.html">

% if ($Scrips->Count > 0 ) {
<TABLE>
<TR>
<TD><&|/l&>Delete</&>
</TD>
<TD>
</TR>

%   while (my $scrip = $Scrips->Next ) {
<TR>
<TD>
<INPUT TYPE="CHECKBOX" NAME="DeleteScrip-<%$scrip->Id%>">
</TD>
<TD>
<% $scrip->ConditionObj->Name %> 
<% $scrip->ActionObj->Name %> 
<&|/l, $scrip->TemplateObj->Name &>with template [_1]</&>
</TD>
</TR>
%   }

</TABLE>

% }
<&|/l&>Add a scrip which will apply to all queues</&>:
<ul>
<li><&|/l&>Condition</&>: <& /Admin/Elements/SelectScripCondition, Name => 'NewScripCondition' &>
	  <&|/l&>Action</&>: <& /Admin/Elements/SelectScripAction, Name => 'NewScripAction' &>
	  <&|/l&>Template</&>: <& /Admin/Elements/SelectTemplate, Name => 'NewScripTemplate' &>

</ul>

<& /Elements/TitleBoxEnd &>
<& /Elements/Submit &>
</FORM>
<%init>
my (@actions, $description);

my $Scrips = new RT::Scrips ($session{'CurrentUser'});
$Scrips->LimitToGlobal();




if ($NewScripAction and $NewScripCondition) {
    my $NewScrip = new RT::Scrip($session{'CurrentUser'});
    
    my ($retval, $msg) = $NewScrip->Create ( ScripAction => $NewScripAction,
				     ScripCondition => $NewScripCondition,
				     Stage => 'TransactionCreate',
				     Queue => 0,
				     Template => $NewScripTemplate);
    if (defined $retval) {
        push @actions, $msg;
    }
    else {
        push @actions, $msg;
    }
}

# {{{ deal with modifying and deleting existing scrips
my ($key );
foreach $key (keys %ARGS) {
  # {{{ if we're trying to delete the scrip
  if ($key =~ /^DeleteScrip-(\d+)/) {
    my $id = $1;
    my $scrip = new RT::Scrip($session{'CurrentUser'});
    $scrip->Load($id);
    my ($retval, $msg) = $scrip->Delete;
    if ($retval) {
      push @actions, "Scrip deleted";
    }
    else {
      push @actions, $msg;
    }
  }
  # }}}
}
# }}}
</%init>

<%ARGS>
$NewScripCondition => undef
$NewScripAction => undef
$NewScripTemplate => undef
</%ARGS>
