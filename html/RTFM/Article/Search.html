<& /RTFM/Article/Elements/Tabs, current_tab => "RTFM/Article/Search.html", Title => loc("Search for articles") &>


<ul>
% while (my $article = $articles->Next) {

<li><a href="Display.html?id=<%$article->Id%>">#<%$article->id%>: <%$article->Name%></a>
<br><font size="-1"><%$article->Summary%></font>
</li>
% }
</ul>

% if ($ARGS{'HideOptions'} == 1) {
% my $qs = $ENV{'QUERY_STRING'};
% $qs =~ s/HideOptions=1//gi;
<a href="Search.html?<%$qs%>">Show advanced search options...</a>
% }  else { 
<& /Elements/TitleBoxStart, title => 'Advanced Search Criteria'&>
<form target="Search.html" method="GET">
<br>Class is <& ../Elements/SelectClass, Name => 'Class', Multiple =>1, Size =>
5 , ShowNullOption => undef,  Default => $ARGS{'Class'} &> 
and is not <& ../Elements/SelectClass, Name => 'Class!', Multiple =>1,
Size => 5 , ShowNullOption => undef, Default => $ARGS{'Class!'} &> 
<br>Name matches 
<input name="Name~" value="<%$ARGS{'Name~'}%>">
and does not match 
<input name="Name!~" value="<%$ARGS{'Name!~'}%>">
<br>Summary matches 
<input Summary="Summary~" value="<%$ARGS{'Summary~'}%>">
and does not match 
<input Summary="Summary!~" value="<%$ARGS{'Summary!~'}%>">

<br>Created between
<& /Elements/SelectDate, Name=>"Created>", Default => ($dates{'Created>'} ? $dates{'Created>'}->ISO : '') &>
and 
<& /Elements/SelectDate, Name=>"Created<", Default => ($dates{'Created<'} ? $dates{'Created<'}->ISO:'')&>

<br>Updated between
<& /Elements/SelectDate, Name=>"LastUpdated>", Default =>
($dates{'LastUpdated>'} ? $dates{'LastUpdated>'}->AsString:'')&>
and 
<& /Elements/SelectDate, Name=>"LastUpdated<", Default => 
($dates{'LastUpdated<'} ? $dates{'LastUpdated<'}->AsString:'')&>
<br>
Which refer to <input type=text size=50 name="RefersTo" value="<%$RefersTo%>">
<i>Seperate multiple URLs with spaces</i>
<br>
Which are referred to by <input type=text size=50 name="ReferredToBy" value="<%$ReferredToBy%>">
<i>Seperate multiple URLs with spaces</i>


<table>
%# for each custom field 
% while (my $field = $customfields->Next ) {

<tr>
<td><%$field->Name%> matches</td><td valign=top>
% my $matches = $field->Name."~";
% my $nomatches = $field->Name."!~";
<& Elements/SearchByCustomField, 
    Field => $field, 
    Name => $matches,
    Values => $ARGS{$matches} &>
    </td>
    <td>and doesn't match</td>
    <td valign="top">
<& Elements/SearchByCustomField, 
    Field => $field, 
    Name => $nomatches,
    Values => $ARGS{$nomatches}
    &>
    </td>
    </tr>

% }
</table>

<div align="right"><input type="submit"></div>
<&/Elements/TitleBoxEnd&>
% }
</form>
<%init>
my $user;
my @results;
if ( $session{'CurrentUser'} ) {
    $user = $session{'CurrentUser'};
}
else {
    $user = RT::CurrentUser->new('RTFM-Guest');
}

my $articles = RT::FM::ArticleCollection->new( $session{'CurrentUser'} );


my $customfields = RT::FM::CustomFieldCollection->new( $session{'CurrentUser'} );
if ( $ARGS{'Class'} ) {
    $customfields->LimitToClass( $ARGS{'Class'} );
}
else {
    $customfields->UnLimit();

}

# Don't want to search for a null class when there is no class specced
my %dates;
foreach my $date qw(Created< Created> LastUpdated< LastUpdated>) {
    next unless ( $ARGS{$date} );
    my $seconds = parsedate( $ARGS{$date}, FUZZY => 1, PREFER_PAST => 1 );
    my $date_obj = RT::Date->new( $session{'CurrentUser'} );
    $date_obj->Set( Format => 'unix', Value => $seconds );
    $dates{$date} = $date_obj;

    if ( $date =~ /^(.*?)<$/i ) {
        $articles->Limit( FIELD           => $1, OPERATOR        => "<=", ENTRYAGGREGATOR => "AND", VALUE           => $date_obj->ISO );
    }

    if ( $date =~ /^(.*?)>$/i ) {
        $articles->Limit( FIELD           => $1, OPERATOR        => ">=", ENTRYAGGREGATOR => "AND", VALUE           => $date_obj->ISO );
    }

}
foreach my $link ( split ( /\s+/, $RefersTo ) ) {
    next unless ($link);
    $articles->LimitRefersTo($link);
}

foreach my $link ( split ( /\s+/, $ReferredToBy ) ) {
    next unless ($link);
    $articles->LimitReferredToBy($link);
}

my %cfs;
my $all_cfs = RT::FM::CustomFieldCollection->new($user);
$all_cfs->UnLimit();
while ( my $cf = $all_cfs->Next ) {
    $cfs{ $cf->Name } = $cf->Id;
}

foreach my $field ( keys %cfs ) {
   
   my @MatchLike = (ref $ARGS{ $field."~" } eq 'ARRAY' ) ? @{ $ARGS{ $field."~" } } : ( $ARGS{$field."~" } );
   my @NoMatchLike = (ref $ARGS{ $field."!~" } eq 'ARRAY' ) ? @{ $ARGS{ $field."!~" } } : ( $ARGS{$field."!~" } );

   my @Match = (ref $ARGS{ $field } eq 'ARRAY' ) ? @{ $ARGS{ $field } } : ( $ARGS{$field } );
   my @NoMatch = (ref $ARGS{ $field."!" } eq 'ARRAY' ) ? @{ $ARGS{ $field."!" } } : ( $ARGS{$field."!" } );

    foreach my $val (@MatchLike) {
        next unless $val;
        push @Match, "~".$val;
    }

    foreach my $val (@NoMatchLike) {
        next unless $val;
        push @NoMatch, "~".$val;
    }


    foreach my $value (@Match) {
        next unless $value;
        my $op;
        if ( $value =~ /^~(.*)$/ ) {
            $value = "%$1%";
            $op    = 'LIKE';
        }
        else {
            $op = '=';
        }
        $articles->LimitCustomField( FIELD           => $cfs{$field},
                                     VALUE           => $value,
                                     ENTRYAGGREGATOR => 'OR',
                                     OPERATOR        => $op );
    }
    foreach my $value (@NoMatch) {
        next unless $value;
        my $op;
        if ( $value =~ /^~(.*)$/ ) {
            $value = "%$1%";
            $op    = 'NOT LIKE';
        }
        else {
            $op = '!=';
        }
        $articles->LimitCustomField( FIELD           => $cfs{$field},
                                     VALUE           => $value,
                                     ENTRYAGGREGATOR => 'OR',
                                     OPERATOR        => $op );
    }
}


foreach my $field qw(Name Summary Class) {
    


   my @MatchLike = (ref $ARGS{ $field."~" } eq 'ARRAY' ) ? @{ $ARGS{ $field."~" } } : ( $ARGS{$field."~" } );
   my @NoMatchLike = (ref $ARGS{ $field."!~" } eq 'ARRAY' ) ? @{ $ARGS{ $field."!~" } } : ( $ARGS{$field."!~" } );

   my @Match = (ref $ARGS{ $field } eq 'ARRAY' ) ? @{ $ARGS{ $field } } : ( $ARGS{$field } );
   my @NoMatch = (ref $ARGS{ $field."!" } eq 'ARRAY' ) ? @{ $ARGS{ $field."!" } } : ( $ARGS{$field."!" } );

    foreach my $val (@MatchLike) {
        next unless $val;
        push @Match, "~".$val;
    }

    foreach my $val (@NoMatchLike) {
        next unless $val;
        push @NoMatch, "~".$val;
    }

    my $op;
    foreach my $value (@Match) {
        if ( $value =~ /^~(.*)$/ ) {
            $value = "%$1%";
            $op    = 'LIKE';
        }
        else {
            $op = '=';
        }

        # preprocess Classes, so we can search on class
        if ( $field eq 'Class' ) {
            my $class = RT::FM::Class->new($RT::SystemUser);
            $class->Load($value);
            $value = $class->Id;
        }

        # now that we've pruned the value, get out if it's different.
        next unless $value;

        $articles->Limit( SUBCLAUSE       => $field . 'Match',
                          FIELD           => $field,
                          OPERATOR        => $op,
                          VALUE            => $value,
                          ENTRYAGGREGATOR => 'OR' );

    }
    foreach my $value (@NoMatch) {
        $RT::Logger->debug( "noMatch value is '$value' for $field");
        

        # preprocess Classes, so we can search on class
        if ( $value =~ /^~(.*)/ ) {
            $value = "%$1%";
            $op    = 'NOT LIKE';
        }
        else {
            $op = '!=';
        }
        if ( $field eq 'Class' ) {
            my $class = RT::FM::Class->new($RT::SystemUser);
            $class->Load($value);
            $value = $class->Id;
        }

        # now that we've pruned the value, get out if it's different.
        next unless $value;

        $articles->Limit( SUBCLAUSE       => $field . 'NoMatch',
                          OPERATOR        => $op,
                          VALUE            => $value,
                          FIELD           => $field,
                          ENTRYAGGREGATOR => 'AND' );

    }
}



</%init>


</%init>
<%ARGS>
$CreatedBefore => ''
$CreatedAfter => ''
$LastUpdatedBefore => ''
$LastUpdatedAfter => ''
$RefersTo => undef
$ReferredToBy => undef

</%ARGS>
