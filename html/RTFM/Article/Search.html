<& /Elements/Header, title => "Search for articles" &>
<& /RTFM/Elements/Tabs, current_top_tab => "RTFM/Article/Search.html"&>

% unless ($ARGS{'Action'} eq loc('Refine')) {
<ul>
% while (my $article = $articles->Next) {

<li><a href="Display.html?id=<%$article->Id%>">#<%$article->id%>: <%$article->Name%></a>
<br><font size="-1"><%$article->Summary%></font>
</li>
% }
</ul>
% }
<h2>Search</h2>

<form target="Search.html" method="GET">
<br>Class is <& ../Elements/SelectClass, Name => 'Class', Default =>
$ARGS{'Class'} &>
<br>Name
<& /Elements/SelectMatch, Name => 'NameOp' , Default => $ARGS{'NameOp'} &>
<input name="Name" value="<%$ARGS{'Name'}%>">

<br>Summary
<& /Elements/SelectMatch, Name => 'SummaryOp',  Default => $ARGS{'SummaryOp'}&>
<input name="Summary" value="<%$ARGS{'Summary'}%>">

<br>Created between
<& /Elements/SelectDate, Name=>"CreatedAfter", Default =>
($dates{'CreatedAfter'} ? $dates{'CreatedAfter'}->AsString : '') &>
and 
<& /Elements/SelectDate, Name=>"CreatedBefore", Default =>
($dates{'CreatedBefore'} ? $dates{'CreatedBefore'}->AsString:'')&>

<br>Updated between
<& /Elements/SelectDate, Name=>"LastUpdatedAfter", Default =>
($dates{'LastUpdatedAfter'} ? $dates{'LastUpdatedAfter'}->AsString:'')&>
and 
<& /Elements/SelectDate, Name=>"LastUpdatedBefore", Default => 
($dates{'LastUpdatedBefore'} ? $dates{'LastUpdatedBefore'}->AsString:'')&>
<br>
Which refer to <input type=text size=50 name="RefersTo" value="<%$RefersTo%>">
<i>Seperate multiple URLs with spaces</i>
<br>
Which are referred to by <input type=text size=50 name="ReferredToBy" value="<%$ReferredToBy%>">
<i>Seperate multiple URLs with spaces</i>


<table>
%# for each custom field 
% while (my $field = $cfs->Next ) {

<tr>
<td><%$field->Name%> matches</td><td valign=top>
% my $arg = $field->Id."-Matches-Values";
<& Elements/SearchByCustomField, 
    Field => $field, 
    Name => $field->Id."-Matches", 
    Values => $ARGS{$arg} &>
    </td>
    <td>and doesn't match</td>
    <td valign="top">
% $arg = $field->Id."-NoMatches-Values";
<& Elements/SearchByCustomField, 
    Field => $field, 
    Name => $field->Id."-NoMatches", 
    Values => $ARGS{$arg}
    &>
    </td>
    </tr>

% }
</table>

<& /Elements/Submit, Label => loc('Show Results'), AlternateLabel => loc('Refine'), Name => 'Action'&>


</form>
<%init>
my $cfs = RT::FM::CustomFieldCollection->new($session{'CurrentUser'});
if ($ARGS{'Class'}) { 
    $cfs->LimitToClass($ARGS{'Class'});
}
my $articles = RT::FM::ArticleCollection->new($session{'CurrentUser'});
# Don't want to search for a null class when there is no class specced
foreach my $arg qw(Class Name Summary) {
    next unless (defined $ARGS{$arg} && $ARGS{$arg} ne ''); #ignore undef values
    $articles->Limit(FIELD => $arg,
                    OPERATOR => $ARGS{$arg."Op"} || '=',
                    VALUE => $ARGS{$arg});
}

foreach my $arg ( keys %ARGS ) {
    if ( $arg =~ /^(\d+)-Matches-Values$/ ) {
	    my @values =ref( $ARGS{$arg} ) ? @{ $ARGS{$arg} } : ( $ARGS{$arg} ); 
	    $articles->LimitToCustomFieldValue( FIELD=> $1,
                                            OPERATOR => 'LIKE',
                                            VALUE    => \@values );

    }
    if ( $arg =~ /^(\d+)-NoMatches-Values$/ ) {
	    my @values =ref( $ARGS{$arg} ) ? @{ $ARGS{$arg} } : ( $ARGS{$arg} ); 
        $articles->LimitToCustomFieldValue( FIELD    => $1,
                                            OPERATOR => 'NOT LIKE',
                                            VALUE    => \@values );

    }
}

my %dates;
foreach my $date qw(CreatedBefore CreatedAfter LastUpdatedBefore LastUpdatedAfter) {
    next unless ($ARGS{$date});
    my $seconds = parsedate ($ARGS{$date}, FUZZY => 1, PREFER_PAST => 1);
    my $date_obj = RT::Date->new($session{'CurrentUser'});
    $date_obj->Set( Format => 'unix', Value => $seconds);
    $dates{$date} = $date_obj;

    if ($date =~ /^(.*?)Before$/i) {
        $articles->Limit( FIELD => $1,
                          OPERATOR => "<=",
                          ENTRYAGGREGATOR => "AND",
                          VALUE => $date_obj->ISO);
    }

    if ($date =~ /^(.*?)After$/i) {
        $articles->Limit( FIELD => $1,
                          OPERATOR => ">=",
                          ENTRYAGGREGATOR => "AND",
                          VALUE => $date_obj->ISO);
    }

}
my $link;
foreach $link (split (/\s+/,$RefersTo)) {
    next unless ($link);
    $articles->LimitRefersTo($link);
}

foreach $link (split(/\s+/,$ReferredToBy)) {
    next unless ($link);
    $articles->LimitReferredToBy($link);
}


</%init>
<%ARGS>
$CreatedBefore => ''
$CreatedAfter => ''
$LastUpdatedBefore => ''
$LastUpdatedAfter => ''
$RefersTo => undef
$ReferredToBy => undef

</%ARGS>
