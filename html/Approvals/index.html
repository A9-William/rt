<& /Elements/Header, Title => loc("My Approvals") &>

<& Elements/Tabs, current_btab => "Approvals/index.html" &>

<& /Elements/ListActions, actions => \@actions &>
<form method="post">
<& Elements/PendingMyApproval, %ARGS &>
<& /Elements/Submit&>
</form>
<%init>

my (@actions);
foreach my $arg ( keys %ARGS ) {

    next unless ( $arg =~ /Approval-(\d+)-Action/ );

    my ( $notesval, $notesmsg );

    my $ticket = LoadTicket($1);

    if ( $ARGS{ "Approval-" . $ticket->Id . "-Notes" } ) {
        my $notes =
          MIME::Entity->build(
                        Data => $ARGS{ "Approval-" . $ticket->Id . "-Notes" } );
        my ( $notesval, $notesmsg ) = $ticket->Correspond( MIMEObj => $notes );
        if ($notesval) {
                push ( @actions, loc("Approval #[_1]: Notes recorded",$ticket->Id ));
        } else {
                push ( @actions, loc("Approval #[_1]: Notes not recorded due to a system error",$ticket->Id ));
        }
    }

    my ($val, $msg);
    if ( $ARGS{$arg} eq 'deny' ) {
         ( $val, $msg ) = $ticket->SetStatus('rejected');
    }
    elsif ( $ARGS{$arg} eq 'approve' ) {
         ( $val, $msg ) = $ticket->SetStatus('resolved');
    }
    push ( @actions, loc("Approval #[_1]: [_2]",$ticket->id, $msg )) if ($msg);
}
</%init>
