%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2010 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<& /Admin/Elements/Header, Title => loc("Theme") &>
<& /Admin/Elements/SystemTabs, 
    current_tab => 'Admin/Global/Theme.html', 
    Title => loc("Theme") &>
<& /Elements/ListActions, actions => \@results &>

<style type="text/css" media="screen" id="test">
</style>

Upload Logo:
<form method="POST" enctype="multipart/form-data">
<input type="file" name="logo-upload" />
<input type="submit">
</form>

% if ($colors) {
Primary colors:
%   for (@$colors) {
%     my $fg = $_->{l} >= 0.6 ? 'black' : 'white';
<span style="background-color: rgb(<% $_->{c} %>); color: <% $fg %>; width: 5em">test l=<% $_->{l}%>></span>
%   }
% }

<div class="clear">

Csutom CSS:
<textarea rows=30 cols=60 id="user_css">
body {background: orange}

div#header h1 { color:black }

input[type="reset"], input[type="submit"], input[class="button"] {background: green}

</textarea>

<input id="try" type="button" value="Try">

<script type="text/javascript">
jQuery(function($) {
  $('#try').click(function() {
    $("style#test").text($('#user_css').val());
  })

});
</script>

<%INIT>
my @results;

use Imager;
use Graphics::Color::RGB;

my $img = Imager->new;
if (my $file_hash = _UploadedFile( 'logo-upload' )) {
    my ($id, $msg) = $RT::System->SetAttribute( Name => "UserLogo", Description => "User-provided logo", Content => \$file_hash->{LargeContent} );
    $img->read(data => $file_hash->{LargeContent} );
}
else {
    my $attr = $RT::System->FirstAttribute('UserLogo');
    my $content = $attr->Content;
    $img->read(data => $$content) or die "Cannot read: ", $img->errstr;
}

my $colors = $img ? analyze_img($img) : undef;
use List::MoreUtils qw(uniq);

sub analyze_img {
    my $img = shift;
    my $color;

    for my $i (0..$img->getwidth-1) {
        for my $j (0..$img->getheight-1) {
            my @color = $img->getpixel(x=>$i, y=>$j)->rgba;
            my $hsl = Graphics::Color::RGB->new( red => $color[0] / 255, green => $color[2] / 255, blue => $color[2] / 255, alpha => $color[3] / 255 )->to_hsl;
            my ($h,$s,$l) = $hsl->as_array;
            pop @color;
            my $c = join(',',@color);
            next if $l < 0.1;
            $color->{$c} ||= { h => $h, s => $s, l => $l, cnt => 0, c => $c};
            $color->{$c}->{cnt}++;
        }
    }

    for (values %$color) {
        $_->{rank} = $_->{s} * $_->{cnt};
    }
    my @top5 = (sort { $b->{rank} <=> $a->{rank} } values %$color)[0..4];
    if ((scalar uniq map {$_->{rank}} @top5) == 1) {
        warn "bad";
    }
    return \@top5;
}


</%INIT>
<%ARGS>

</%ARGS>
