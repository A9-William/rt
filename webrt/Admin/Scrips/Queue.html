<& /Admin/Elements/Header, Title => 'Edit scrips' &>


<& /Elements/ListActions, actions => \@actions &>

<h1><%$description%></h1>
  
  <FORM METHOD=POST>
    <INPUT TYPE=HIDDEN NAME=Queue VALUE=<%$Queue%>>
      
      <UL>
% while (my  $scrip  = $Scrips->Next ) {
	
<LI
    >Condition: <& /Admin/Elements/SelectScripCondition,  Name => 'ConditionForScrip-'.$scrip->Id, Default => $scrip->ScripCondition &>>
	  Action: <& /Admin/Elements/SelectScripAction,  Name => 'ActionForScrip-'.$scrip->Id, Default => $scrip->ScripAction &>
	  Template: <& /Admin/Elements/SelectTemplate, Name => 'TemplateForScrip-'.$scrip->Id, Default => $scrip->Template &>

</LI>
% }
</ul>
Add a scrip to this queue:
<ul>
<li>Condition: <& /Admin/Elements/SelectScripCondition, Name => 'NewScripCondition' &>
	  Action: <& /Admin/Elements/SelectScripAction, Name => 'NewScripAction' &>
	  Template: <& /Admin/Elements/SelectTemplate, Name => 'NewScripTemplate', DefaultQueue => $Queue &>

</ul>
<& /Elements/Submit &>
</FORM>
<%init>
my (@actions, $description);


my $Scrips = new RT::Scrips ($session{'CurrentUser'});
unless ($Queue =~ /^\d+$/) {
    Abort("$Queue isn't a valid Queue id.");
}


unless ($Scrips->LimitToQueue($Queue)) {
    Abort("Couldn't load Scrips.");
        }

my $QueueObj = new RT::Queue($session{'CurrentUser'});
$QueueObj->Load($Queue);

if ($QueueObj->id) {
    $description = "Modify scrips for queue '". $QueueObj->QueueId ."'";
}
else {
    $description = "Modify global scrips";
}


if ($NewScripAction and $NewScripCondition) {
    my $NewScrip = new RT::Scrip($session{'CurrentUser'});
    
    my $retval = $NewScrip->Create ( ScripAction => $NewScripAction,
				     ScripCondition => $NewScripCondition,
				     Stage => 'TransactionCreate',
				     Queue => $Queue,
				     Template => $NewScripTemplate);
    if (defined $retval) {
        push @actions, "Scrip added to queue";
    }
    else {
        push @actions, "Scrip could not be added to queue";
    }
}

# {{{ deal with modifying and deleting existing scrips
my ($key );
foreach $key (keys %ARGS) {
    if ($key =~ /^ActionForScrip-(\d*)$/) {
	my $id = $1;
	my $scrip = new RT::Scrip($session{'CurrentUser'});
	$scrip->Load($id);
	
	
	# {{{ if we're trying to delete the scrip
	if ( ( $ARGS{"ActionForScrip-".$id} eq "") and
	     ( $ARGS{"ConditionForScrip-".$id} eq "") ) {

            $scrip->Delete;
	}

	# }}}
	# {{{ modify the scrip	
        else {

	    if ($ARGS{"ConditionForScrip-".$id} ne $scrip->ScripCondition) {
		my ($code,$msg) = 
		  $scrip->SetScripCondition($ARGS{"ConditionForScrip-".$id});
		push @actions, $msg;
	    }
	    if ($ARGS{"ActionForScrip-".$id} ne $scrip->ScripAction) {
		my ($code,$msg) = 
		  $scrip->SetScripAction($ARGS{"ActionForScrip-".$id});
		push @actions, $msg;
	    }
	    
	    if ($ARGS{"STemplateForScrip-".$id} ne $scrip->Template) {
		my ($code,$msg) = 
		  $scrip->SetTemplate($ARGS{"TemplateForScrip-".$id});
		push @actions, $msg;
	    }
	}	

	# }}}


    }
}
# }}}
</%init>

<%ARGS>
$NewScripCondition => undef
$NewScripAction => undef
$NewScripTemplate => undef
$Queue => undef         #some identifier that a Queue could 
</%ARGS>
