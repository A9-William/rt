<HTML>
<HEAD>
</HEAD>
<BODY BGCOLOR="#FFFFFF">
<H1>WebRT Queue</H1>


%#<& QueueInterpretRestrictionCookies &>
<TABLE WIDTH=100%>
%#<& QueueHeader format="$format" &>
<TR>
%foreach (@{_cfg(\%ARGS, 'QueueListingCols')}) {
   <TH><% $_->{Header} %>
%}

%while (my $Ticket = $Tickets->Next) {
<TR>
%foreach (@{_cfg(\%ARGS, 'QueueListingCols')}) {
	<TD>
	<& TicketCell , Ticket=>$Ticket,  Column=>$_ &>
	</TD>
%}
</TR>
%}
</TABLE>
%#<& QueueFooter format="$format" &>

<HR>

<& PickRestriction, CurrentUser => $CurrentUser &>
  

<%INIT>

use RT::Tickets;
use RT::CurrentUser;

my $CurrentUser = RT::CurrentUser->new(2);
my $Tickets = RT::Tickets->new($CurrentUser);


if ($ARGS{'LimitOwner'}) {
  my $oper;
  if ($ARGS{'NegateOwner'}==1) {
    $oper = "!=";
  }
  else {
    $oper = "=";
  }
  
  # Better error handling is certainly needed.  I'll just use die as for
  # now.  If die is a big problem, it's possible to trap it anyway.
  die "Huh? LimitOwner specified, but not ValueOfOwner."
      unless $ARGS{'ValueOfOwner'};
  
  $Tickets->Limit (FIELD => 'Owner',
		   VALUE => $ARGS{'ValueOfOwner'},
		   OPERATOR => "$oper"
		  )
}


if (0) {
# TODO: this code requires some creative use of EasySearch that I'm not up to 
# right now
#if ($ARGS{'LimitRequestor'}) {
  my $oper;
  if ($ARGS{'NegateRequestor'}==1) {
  
    $oper = "NOT LIKE";
  }
  else {
    $oper = "LIKE";
  }
  
  $Tickets->Limit (FIELD => 'Requestors',
		   VALUE => $ARGS{'ValueOfRequestors'},
		   OPERATOR => "$oper"
		  )
}


if ($ARGS{'LimitSubject'}) {
 my $oper; 
  if ($ARGS{'NegateSubject'}==1) {
    $oper = "NOT LIKE";
  }
  else {
    $oper = "LIKE";
  }
  
  $Tickets->Limit (FIELD => 'Subject',
		   VALUE => $ARGS{'ValueOfSubject'},
		   OPERATOR => "$oper"
		  )
}



if ($ARGS{'LimitQueue'}) {
  my $oper;
  if ($ARGS{'NegateQueue'}==1) {
    $oper = "!=";
  }
  else {
    $oper = "=";
  }
  
  $Tickets->Limit (FIELD => 'Queue',
		   VALUE => $ARGS{'ValueOfQueue'},
		   OPERATOR => "$oper"
		  )
}

if ($ARGS{'LimitStatus'}) {
  my $oper;
  if ($ARGS{'NegateStatus'}==1) {
    $oper = "!=";
  }
  else {
    $oper = "=";
  }
  
  $Tickets->Limit (FIELD => 'Status',
		   VALUE => $ARGS{'ValueOfStatus'},
		   OPERATOR => "$oper"
		  )
}

# TODO: This one should _not_ be here, rather somewhere else
# (suggestions?).  It might eventually read the cookies, user
# configuration information from the DB, queue configuration information
# from the DB, etc.  It should be object oriented.  But what object can
# it belong to, and how should it get access to all this data?

sub _cfg {
  my $args=shift;
  my $key=shift;
  return $args->{$key} || $RT::SitePolicy{$key};
}

# $Tickets->Limit( FIELD => 'status',
#			VALUE => "open");
</%INIT>
