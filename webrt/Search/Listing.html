%# $Header$
%# Copyright 1996-2000 Jesse Vincent <jesse@fsck.com>

<& /Elements/Header, Title => "WebRT Ticket Listing" &>

%#Foo<% $foo %>bar

%#<& QueueInterpretRestrictionCookies &>
<TABLE WIDTH=100%>
%#<& QueueHeader format="$format" &>
<TR>
%foreach (@{_cfg(\%ARGS, 'QueueListingCols')}) {
   <TH><% $_->{Header} %>
%}

%while (my $Ticket = $session{'tickets'}->Next) {
<TR>

%# The ticket view is controlled by config.pm, WebOptions

%foreach (@{_cfg(\%ARGS, 'QueueListingCols')}) {
	<TD>
	<& TicketCell , Ticket=>$Ticket,  Column=>$_ &>
	</TD>
%}
</TR>
%}
</TABLE>
%#<& QueueFooter format="$format" &>

<HR>

<& PickRestriction &>

<%INIT>

# temporary disabling features that won't work ... --
# tobix.. (besides, the "current restrictions" must be listed up, and it
# must be possible to remove restrictions if this should make any sense)

  if (!$ARGS{'keep'} || !defined $session{'tickets'}) {
    use RT::TicketCollection;
    $session{'tickets'} = RT::TicketCollection->new($session{'CurrentUser'});
    
  }
  else {
    $session{'tickets'}->NewTickets;
  }
if ($ARGS{'LimitResultsPerPage'} and ($ARGS{'ValueOfResultsPerPage'}>0)) {
  
  $session{'tickets'}->Rows ($ARGS{'ValueOfResultsPerPage'});
}


if ($ARGS{'LimitOwner'} and $ARGS{'ValueOfOwner'}) {
  my $oper = $ARGS{'NegateOwner'} ? "!=" : "=";
  $session{'tickets'}->NewRestriction (FIELD => 'Owner',
				       VALUE => $ARGS{'ValueOfOwner'},
				       OPERATOR => "$oper"
				      );
}

if (0) {
  # TODO: this code requires some creative use of EasySearch that I'm not up to 
  # right now
  #if ($ARGS{'LimitRequestor'}) {
  my $oper = $ARGS{'NegateRequestor'} ? "!=" : "="; 
  $session{'tickets'}->NewRestriction (FIELD => 'Requestors',
				       VALUE => $ARGS{'ValueOfRequestors'},
				       OPERATOR => "$oper"
				      )
}


if ($ARGS{'LimitSubject'}) {
  my $val=$ARGS{'ValueOfSubject'};
  my $oper = $ARGS{'NegateSubject'} || "=";
  $oper="!=" if ($oper eq 1);
  if ($oper eq 'Like') {
     $val="%$val%";
  }
  $session{'tickets'}->NewRestriction (FIELD => 'Subject',
				       VALUE => $val,
				       OPERATOR => $oper
				      )
}


if ($ARGS{'LimitQueue'}) {
  my $oper = $ARGS{'NegateQueue'} ? "!=" : "="; 
  $session{'tickets'}->NewRestriction (FIELD => 'Queue',
				       VALUE => $ARGS{'ValueOfQueue'},
				       OPERATOR => "$oper"
				      )
}


if ($ARGS{'LimitStatus'}) {
  my $oper = $ARGS{'NegateStatus'} ? "!=" : "="; 
  $session{'tickets'}->NewRestriction (FIELD => 'Status',
				       VALUE => $ARGS{'ValueOfStatus'},
				       OPERATOR => "$oper"
				      )
}

$session{'tickets'}->ApplyRestrictions;

#$foo =$session{'tickets'}->Restrictions;

# TODO: This one should _not_ be here, rather somewhere else
# (suggestions?).  It might eventually read the cookies, user
# configuration information from the DB, queue configuration information
# from the DB, etc.  It should be object oriented.  But what object can
# it belong to, and how should it get access to all this data?

sub _cfg {
  my $args=shift;
  my $key=shift;
  return $args->{$key} || $RT::WebOptions{$key};
}


</%INIT>

<%ARGS>
$foo => undef
</%ARGS>
