%# $Header$
%# Copyright 1996-2000 Jesse Vincent <jesse@fsck.com>

<& /Elements/Header, Title => "Ticket #".$Ticket->Id ." ".$Ticket->Subject &>
<& /Ticket/Elements/Tabs, Ticket => $Ticket, current_tab => 'Ticket/Display.html?id='.$Ticket->id &>

<& /Elements/ListActions, actions => \@Actions &>

<& /Ticket/Elements/ShowSummary,  Ticket => $Ticket &>


<BR>
<& /Elements/Section, title =>'Ticket History' &>

<BR>
      
<& /Ticket/Elements/ShowHistory , Ticket => $Ticket, Collapsed => 0, ShowHeaders => $ARGS{'ShowHeaders'} &> 


<%ARGS>
$id => undef
$Create => undef
</%ARGS>

<%INIT>

  
  my ($linkid, $message, $tid, $Ticket, @Actions);  

$Ticket = new RT::Ticket($session{'CurrentUser'});

unless ($id) {
    Abort('No ticket specified');
}

if ($ARGS{'id'} eq 'new') {
    # {{{ Create a new ticket
    
    my $Queue = new RT::Queue($session{'CurrentUser'});	
    unless ($Queue->Load($ARGS{'Queue'})) {
	Abort('Queue not found');
    }
    
    unless ($Queue->CurrentUserHasRight('CreateTicket')) {
	Abort('You have no permission to create tickets in that queue.');
    }
    
    my @Requestors = split(/,/,$ARGS{'Requestors'});
    my @Cc = split(/,/,$ARGS{'Cc'});
    my @AdminCc = split(/,/,$ARGS{'AdminCc'});
    
    
    require MIME::Entity;
    my $MIMEObj = MIME::Entity->build(Subject => $ARGS{Subject},
				      From => $ARGS{Requestors},
				      Cc => $ARGS{Cc},
				      Data => $ARGS{Content}
				     );
    
    #TODO in Create_Details.html: priorities and due-date      
    my ($id, $Trans, $ErrMsg)= $Ticket->Create(Queue=>$ARGS{Queue},
					       Owner=>$ARGS{ValueOfOwner},
					       Requestor=> \@Requestors,
					       Cc => \@Cc,
					       AdminCc => \@AdminCc,
					       Subject=>$ARGS{Subject},
					       Status=>$ARGS{Status},
					       MIMEObj => $MIMEObj	  
					      );         
    unless ($id && $Trans) {
	Abort($ErrMsg);
    }

    push(@Actions, $ErrMsg);

    # }}}
}

else { 
    unless ($Ticket->Load($ARGS{id})) {
	Abort("Ticket couldn't be loaded");
    }	
    unless ($Ticket->CurrentUserHasRight('ShowTicket')) {
	Abort("No permission to view ticket");
    }
}


if (defined $ARGS{'Action'}) {
  if ($ARGS{'Action'} =~ /^(Steal|Kill|Take|SetTold)$/) {
    my $action = $1;
    my ($res, $msg)=$Ticket->$action();
    $RT::Logger->debug("Dealing with $action on $Ticket: $res/$msg\n");
    push(@Actions, $msg);
  }
}
    
$RT::Logger->debug("About to process things\n");
ProcessUpdateMessage(ARGSRef=>\%ARGS, Actions=>\@Actions, TicketObj=>$Ticket);
$RT::Logger->debug("About to process actions\n");

#Process status updates
ProcessTicketBasics(ARGSRef => \%ARGS, Actions=>\@Actions, TicketObj=>$Ticket);


</%INIT>




