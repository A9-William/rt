%# $Header$
%# Copyright 1996-2000 Jesse Vincent <jesse@fsck.com>

<& /Elements/Header, Title => "Ticket View (#".$Ticket->Id.($Ticket->Subject&&(", ".$Ticket->Subject)).")" &>

% for (@Actions) {
   <%$_%><br>
% }


<& /Ticket/Elements/TicketToolBox, Ticket => $Ticket&>

<& /Ticket/Elements/ShowSummary,  Ticket => $Ticket &>
<& /Elements/TitleBoxEnd &>

<h1>Ticket History</h1>

<& /Ticket/Elements/ShowHistory , Ticket => $Ticket &> 

<& /Elements/TitleBoxEnd &>

<%ARGS>
$id => undef
$Ticket => undef
@Actions => ()
</%ARGS>

<%INIT>

&Error('No ticket specified') unless $id||$Ticket;

use RT::Ticket;
use RT::CurrentUser;
use RT::Interface::Web;

&CreateOrLoad;

# Eventually, link up the ticket:

  if (my $l=$ARGS{'Link'}) {
    # There is some redundant information from the forms now - we'll
    # ignore one bit of it:

    my $luris=$ARGS{'LinkTo'} || $ARGS{'LinkFrom'};
    my $ltyp=$ARGS{'LinkType'};
    if (ref $ltyp) {
        &mc_comp("/Elements/Error" , Why => "Parameter error");
        $m->abort;
    }
    for my $luri (split (/ /,$luris)) {
      warn $luri;
      my ($LinkId, $Message);
      if ($l eq 'LinkTo') {
        ($LinkId,$Message)=$Ticket->LinkTo(Target=>$luri, Type=>$ltyp);
      } elsif ($l eq 'LinkFrom') {
        ($LinkId,$Message)=$Ticket->LinkFrom(Base=>$luri, Type=>$ltyp);
      } else {
        &mc_comp("/Elements/Error" , Why => "Parameter error");
        $m->abort;
      }
      warn $Message;


      
      push(@Actions, $Message);
    }
  }


      # Eventually, take the ticket:
      # TODO: What if there are more Actions?
      if (exists $ARGS{Action} && $ARGS{Action} eq "Take") {
         my ($res, $msg)=$Ticket->Take;
	 push(@Actions, $msg);
      }

      # Eventually, steal the ticket:
      # TODO: What if there are more Actions?
      if (exists $ARGS{Action} && $ARGS{Action} eq "Steal") {
         my ($res, $msg)=$Ticket->Steal;
	 push(@Actions, $msg);
      }

      # Eventually, kill the ticket:
      if (exists $ARGS{Action} && $ARGS{Action} eq "Kill") {
         my ($res, $msg)=$Ticket->Kill;
	 push(@Actions, $msg);
      }

      # Eventually, touch the Told:
      if (exists $ARGS{Action} && $ARGS{Action} eq "UpdateTold") {
         my ($res, $msg)=$Ticket->UpdateTold;
	 push(@Actions, $msg);
      }

</%INIT>




