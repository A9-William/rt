%# $Header$
%# Copyright 1996-2000 Jesse Vincent <jesse@fsck.com>

<& /Elements/Header, Title => "Ticket #".$Ticket->Id.($Ticket->Subject&&(", ".$Ticket->Subject))."" &>
<& /Elements/Tabs &>

% for (@Actions) {
   <%$_%><br>
% }


<& /Ticket/Elements/TicketToolBox, Ticket => $Ticket&>

<& /Ticket/Elements/ShowSummary,  Ticket => $Ticket &>
<& /Elements/TitleBoxEnd &>
<h1>Ticket History</h1>

<& /Ticket/Elements/ShowHistory , Ticket => $Ticket, ShowHeaders => $ARGS{'ShowHeaders'} &> 

<& /Elements/TitleBoxEnd &>



<%ARGS>
$id => undef
$Create => undef
</%ARGS>

<%INIT>


my ($linkid, $message, $tid, $Ticket, @Actions);  


$Ticket = new RT::Ticket($session{'CurrentUser'});

unless ($id) {
    Abort('No ticket specified');
}

if ($ARGS{'id'} eq 'new') {
    # {{{ Create a new ticket
    
    my $Queue = new RT::Queue($session{'CurrentUser'});	
    unless ($Queue->Load($ARGS{'queue'})) {
	Abort('Queue not found');
    }
    
    unless ($Queue->CurrentUserHasRight('CreateTicket')) {
	Abort('You have no permission to create tickets in that queue.');
    }
    
    require MIME::Entity;
    my $MIMEObj = MIME::Entity->build(Subject => $ARGS{Subject},
				      From => $ARGS{Requestors},
				      Cc => $ARGS{Cc},
				      Data => $ARGS{Content}
				     );
    
    #TODO in Create_Details.html: priorities and due-date      
    my ($id, $Trans, $ErrMsg)= $Ticket->Create( 
					       Queue=>$ARGS{queue},
					       Owner=>$ARGS{ValueOfOwner},
					       RequestorEmail=>$ARGS{Requestors},
					       Subject=>$ARGS{Subject},
					       Status=>$ARGS{Status},
					       MIMEObj => $MIMEObj	  
					      );         
    unless ($id && $Trans) {
	Abort($ErrMsg);
	
    }
    push(@Actions, $ErrMsg);

    # }}}
}

else { 
    unless ($Ticket->Load($ARGS{id})) {
	Abort("Ticket couldn't be loaded");
    }	
    unless ($Ticket->CurrentUserHasRight('ShowTicket')) {
	Abort("No permission to view ticket");
    }
}

if ($ARGS{'DependsOn'}){
    ($linkid, $message, $tid) = $Ticket->LinkFrom( Base => $ARGS{'DependsOn'}, Type => 'DependsOn');
    push @Actions, $message;
}

if ($ARGS{'DependedOnBy'}){
    ($linkid, $message, $tid) = $Ticket->LinkTo( Target => $ARGS{'DependedOnBy'}, Type => 'DependsOn');
    push @Actions, $message;
}


if ($ARGS{'MemberOf'}){
    ($linkid, $message, $tid) = $Ticket->LinkTo( Target => $ARGS{'MemberOf'}, Type => 'MemberOf');
    push @Actions, $message;
}


$id=$Ticket->Id;

# Eventually, link up the ticket:

&LinkUpIfRequested(ARGS=>\%ARGS, Actions=>\@Actions, Ticket=>$Ticket);


# Eventually, update the told, take, steal, kill the ticket:

&ProcessSimpleActions(ARGS=>\%ARGS, Actions=>\@Actions, Ticket=>$Ticket);

</%INIT>




