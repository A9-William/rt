<!-- Transaction <%$Ticket->Id%>/<%$Transaction->Id%> -->
<& /Elements/TitleBoxStart, 
	title => 
		$Transaction->CreatedAsString. " " .  $TicketString . 
 		$Transaction->Description.  $TimeTaken,

	titleright=> $titlebar_commands &>

% unless ($Collapsed) {

%# I had to temporarly move this one because the box grew too wide when a message was too wide.

% $attachments->GotoFirstItem;
%  while (my $message=$attachments->Next) {
<TABLE WIDTH="100%">
<TR>
<TD>

<pre>
%if ($FullHeaders) {
<%$message->Headers %>
% } else {
<%$message->NiceHeaders %>
%}
</pre>
</TD>
<TD VALIGN=TOP ALIGN=RIGHT>
%if ($FullHeaders) {
<A HREF="Display.html?id=<%$Transaction->TicketObj->id%>">Brief headers</a>
% } else {
<A HREF="Display.html?ShowHeaders=<%$Transaction->Id%>&id=<%$Transaction->TicketObj->id%>">Full headers</a>
%}
<BR>
<%PERL>
my $size = length($message->Content());

if ($size) {

if ($size > 1024) {
	$size = int($size/102.4)/10 . "k";
}
else {
	$size = $size ."b";
}
</%PERL>
<A HREF="Attachment/<%$Transaction->Id%>/<%$message->Id%>/<%$message->Filename%>">Download <%$message->Filename%></a> <% $size %><br>

% }

</TD>
</TR>
</TABLE>
% # 13456 is a random # of about the biggest size we'd want to see inline text
%   if ($message->ContentType =~ m{^(text/plain|message|text$)}i && length($message->Content)<13456) {
<pre>
%#TODO We're now HTML escaping the message content, but should
%#TODO probably deal with converting links
<% $message->Content %>
</pre>
%    }  
% elsif ($message->ContentType =~ m{^multipart}) {
<i>This is a multipart message</i>
% } 

% }

% }
<& /Elements/TitleBoxEnd &>


<%ARGS>
$Ticket => undef
$Transaction => undef
$FullHeaders => undef
$Collapsed => undef
</%ARGS>

<%INIT>
my ($TimeTaken, $TicketString);

if ($Ticket->Id != $Transaction->Ticket) {
	$TicketString = "(Ticket ".$Transaction->Ticket .") ";
}

if ($Transaction->TimeTaken > 0) {
	$TimeTaken = " (". $Transaction->TimeTaken." min) "
}
my $attachments = $Transaction->Attachments;

my $titlebar_commands='';

# If the transaction has anything attached to it at all
if ($Transaction->Message) {
	if ($Transaction->TicketObj->CurrentUserHasRight('ReplyToTicket')) {
		$titlebar_commands .= 
	  	  "[<a class='inverse' href=\"Update.html?id=".
		  $Transaction->Ticket . "&QuoteTransaction=".$Transaction->Id.
		  "&Action=Respond\">Reply</a>] ";
	}
	if ($Transaction->TicketObj->CurrentUserHasRight('CommentOnTicket')) {
	     $titlebar_commands .= 
	     "[<a class='inverse' href=\"Update.html?id=".$Transaction->Ticket. 
	     "&QuoteTransaction=".$Transaction->Id.
	     "&Action=Comment\">Comment</a>]";
	}
}

</%INIT>
