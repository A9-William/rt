 <& /Elements/TitleBoxStart, 
	title => 
$Transaction->CreatedAsString. " " . 
$TicketString .
$Transaction->Description.  
$TimeTaken,

	titleright=> $Transaction->Message->First ? ($RT::WebOptions{ExtraTransactionActions}->(Transaction=>$Transaction) . "[<a class='inverse' href=\"Update.html?id=".$Transaction->Ticket . "&QuoteTransaction=".$Transaction->Id."&Action=Respond\">Reply</a>] [<a class='inverse' href=\"Update.html?id=".$Transaction->Ticket . "&QuoteTransaction=".$Transaction->Id."&Action=Comment\">Comment</a>]</a>") : "" &>

% unless ($Collapsed) {

%# I had to temporarly move this one because the box grew too wide when a message was too wide.

% $attachments->GotoFirstItem;
%  while (my $message=$attachments->Next) {
<TABLE WIDTH="100%">
<TR>
<TD>

<pre>
%if ($FullHeaders) {
<%$message->Headers %>
% } else {
<%$message->NiceHeaders %>
%}
</pre>
</TD>
<TD VALIGN=TOP ALIGN=RIGHT>
%if ($FullHeaders) {
<A HREF="Display.html?id=<%$Transaction->TicketObj->id%>">Brief headers</a>
% } else {
<A HREF="Display.html?ShowHeaders=<%$Transaction->Id%>&id=<%$Transaction->TicketObj->id%>">Full headers</a>
%}
</TD>
</TR>
</TABLE>
% # 13456 is a random # of about the biggest size we'd want to see inline text
%   if ($message->ContentType =~ m{^(text/plain|message)}i && length($message->Content)<13456) {
<pre>
%#TODO We're now HTML escaping the message content, but should
%#TODO probably deal with converting links
<% $message->Content %>
</pre>
%    }  
% elsif ($message->ContentType =~ m{^multipart}) {
This is a multipart message
% } else {
	
Attachment: <A HREF="Attachment/<%$Transaction->Id%>/<%$message->Id%>/<%$message->Filename%>">Download <%$message->Filename%></a> <% int(length($message->Content())/1024)%>k<br>

%  }
% }

% }
<& /Elements/TitleBoxEnd &>


<%ARGS>
$Ticket => undef
$Transaction => undef
$FullHeaders => undef
$Collapsed => undef
</%ARGS>

<%INIT>
my ($TimeTaken, $TicketString);

if ($Ticket->Id != $Transaction->Ticket) {
	$TicketString = "(Ticket ".$Transaction->Ticket .") ";
}

if ($Transaction->TimeTaken > 0) {
	$TimeTaken = " (". $Transaction->TimeTaken." min) "
}
my $attachments = $Transaction->Attachments;

</%INIT>
